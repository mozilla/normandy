version: 2
jobs:
  build:
    docker:
      - image: ubuntu:zesty
      - image: circleci/postgres:9.5.2

    working_directory: /root/normandy

    steps:
      - checkout

      - setup_remote_docker

      - run:
          name: Prepare environment
          command: |
            chmod -R 777 $CIRCLE_TEST_REPORTS $CIRCLE_ARTIFACTS
            # Use pipstrap to bootstrap a trusted pip 8 for hash checking.
            ./ci/circle/ci/bin/pipstrap.py
            # Install latest pip (for constraint support), then the rest of the CI requirements.
            pip install -r ./ci/circleci/requirements/pip.txt
            pip install -r ./ci/circleci/requirements/default.txt -c ./ci/circleci/requirements/constraints.txt

      - run:
          name: Lint Dependencies
          working_directory: /root/normandy/lints
          command: ./bin/ci/dependencies

      - run:
          name: Lints
          working_directory: /root/normandy/lints
          command: ./bin/ci/test

      - run:
          name: Recipe Server Dependencies
          working_directory: /root/normandy/recipe-server
          command: ./bin/ci/dependencies

      - run:
          name: Recipe Server Test
          working_directory: /root/normandy/recipe-server
          command: ./bin/ci/test

      - run:
          name: Mock Server Dependencies
          working_directory: /root/normandy/mock-recipe-server
          environment:
            MOCK_SERVER_DOMAIN: https://normandy-mock.dev.mozaws.net
            MOCK_SERVER_ARTIFACTS: "${CIRCLE_ARTIFACTS}/mock-recipe-server"
          command: ./bin/ci/dependencies

      - run:
          name: Mock Server Compile
          working_directory: /root/normandy/mock-recipe-server
          environment:
            MOCK_SERVER_DOMAIN: https://normandy-mock.dev.mozaws.net
            MOCK_SERVER_ARTIFACTS: "${CIRCLE_ARTIFACTS}/mock-recipe-server"
          command: ./bin/ci/compile

      - run:
          name: Mock Server Test
          working_directory: /root/normandy/mock-recipe-server
          environment:
            MOCK_SERVER_DOMAIN: https://normandy-mock.dev.mozaws.net
            MOCK_SERVER_ARTIFACTS: "${CIRCLE_ARTIFACTS}/mock-recipe-server"
          command: ./bin/ci/test





# TODO TODO TODO
# deployment:
#   latest:
#     branch: master
#     commands:
#       - ./ci/circleci/bin/runner.sh deploy latest
#
#   tags:
#     # push all tags
#     tag: /.*/
#     commands:
#       - ./ci/circleci/bin/runner.sh deploy "$CIRCLE_TAG"
